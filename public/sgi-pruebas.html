<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario | SGI - Gestión Completa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --color-primary: #1a73e8; /* Azul Google */
            --color-secondary: #0f9d58; /* Verde Google */
            --color-bg: #f8f9fa; /* Fondo claro */
            --color-red: #ea4335; /* Rojo Google */
            --color-yellow: #fbbc04; /* Amarillo Google */
            --color-sidebar-bg: #ffffff; /* Fondo del menú */
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-deep: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-bg);
            margin: 0;
            overflow-x: hidden;
            color: #333;
        }

        /* Estilo para los Iconos de Google */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            color: var(--color-primary);
        }

        /* --- Transición de Pantalla Completa --- */
        .full-screen-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 3000;
            background-color: #ffffff;
            opacity: 1;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .hidden-section {
            opacity: 0 !important;
            visibility: hidden;
            transform: translateY(-100%);
        }

        #bienvenida h1 {
            font-size: 4em;
            color: var(--color-primary);
            animation: bounceIn 1s forwards;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .login-card {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-deep);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 6px; box-sizing: border-box; }
        .login-btn, .btn-submit {
            background-color: var(--color-primary);
            color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; width: 100%;
            font-size: 1.1em; transition: background-color 0.3s;
        }
        .login-btn:hover, .btn-submit:hover { background-color: #1558b0; }

        /* --- NUEVO LAYOUT DE MENÚ LATERAL --- */
        #main-layout {
            display: flex;
            min-height: 100vh;
            width: 100%;
            display: none; /* Se muestra después del login */
        }

        /* Menú Lateral Izquierdo */
        #sidebar {
            width: 250px;
            background-color: var(--color-sidebar-bg);
            box-shadow: var(--shadow-deep);
            padding: 20px 0;
            flex-shrink: 0;
        }

        /* ESTILOS AÑADIDOS/MODIFICADOS PARA EL LOGO */
        #logo-container {
            display: flex;
            align-items: center; /* Centra verticalmente el logo y el texto */
            padding: 0 20px;
            margin-bottom: 25px;
        }

        #logo-img {
            width: 40px; /* Tamaño moderado para el logo */
            height: 40px;
            margin-right: 10px;
            border-radius: 4px; /* Opcional: para logos cuadrados o circulares */
        }

        #sidebar h2 {
            color: var(--color-primary);
            font-size: 1.5em;
            margin: 0; /* Asegura que no haya margen extra del h2 */
        }
        /* FIN ESTILOS LOGO */

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background-color: var(--color-primary);
            color: white;
        }
        .sidebar-item:hover .material-symbols-outlined, .sidebar-item.active .material-symbols-outlined {
            color: white;
        }
        .sidebar-item .material-symbols-outlined {
            margin-right: 15px;
            font-size: 1.5em;
        }

        /* Estilo para el selector de Inventario Activo */
        #inventory-selector-container {
            padding: 10px 20px;
            border-top: 1px solid #eee;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        #inventory-selector-container label {
            font-size: 0.9em;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        /* Área de Contenido Derecha */
        #content-area {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--color-bg);
        }

        /* Encabezado y Botón de Salida */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .btn-delete {
            background-color: var(--color-red);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .btn-delete:hover { background-color: #b0150d; }


        /* Contenedor Interior con Límite (El "Recuadro Grande") */
        #content-wrapper {
            max-width: 1000px; /* Límite máximo para el contenido */
            margin: 0 auto; /* Centrar el contenido en el área derecha */
            padding: 30px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: var(--shadow-deep);
        }

        .form-content {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            background-color: #f1f3f4; /* Fondo ligero para formularios */
        }
        .form-content h3 { color: var(--color-primary); }

        /* --- Estilos de la PÁGINA DE INICIO (HOME) --- */
        #home-content {
            display: block; /* Visible por defecto al entrar al layout */
            background-color: #ffffff;
            padding: 0;
        }

        .home-card {
            padding: 30px;
            border-radius: 12px;
            border-left: 5px solid var(--color-secondary);
            margin-bottom: 20px;
            background-color: #f7fcf9;
            box-shadow: var(--shadow-light);
        }
        .home-card h4 { color: var(--color-secondary); }
        .home-card h5 { margin-top: 0; color: #333; }

        /* Estilos específicos para el tutorial */
        .tutorial-card-primary { border-left-color: var(--color-primary) !important; }
        .tutorial-card-secondary { border-left-color: var(--color-secondary) !important; }
        .tutorial-card-yellow { border-left-color: var(--color-yellow) !important; }

        /* --- Estilos para la tabla e inputs (se mantienen) --- */
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 15px; background: white;
            box-shadow: var(--shadow-light);
        }
        .data-table th, .data-table td {
            padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left;
        }
        .data-table th { background-color: var(--color-primary); color: white; }
        .data-table tr:hover { background-color: #f0f0f0; cursor: pointer; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        .form-group label { width: 100px; font-weight: bold; }
        .form-group input, .form-group textarea { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .stock-bajo { font-weight: bold; color: var(--color-red); }

        .btn-table {
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-stock { background-color: var(--color-secondary); }

        /* Modal Generico */
        .modal {
            display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 480px; border-radius: 10px; box-shadow: var(--shadow-deep);
        }

        /* Pequeños ajustes para inputs dentro del modal */
        .modal-content .form-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
        .modal-content label { width: 100px; font-weight:600; }
        .modal-content input, .modal-content select { padding:8px; border-radius:6px; border:1px solid #ccc; flex:1; }

    </style>
</head>
<body>

<section id="bienvenida" class="full-screen-section">
    <h1> BIENVENIDOS A SGI </h1>
</section>

<section id="login-section" class="full-screen-section" style="background-color: var(--color-bg); opacity: 0; visibility: hidden; transition: opacity 0.5s;">
    <div class="login-card">
        <h2>LOGIN</h2>
        <form id="login-form">
            <div class="input-group"><input type="text" id="username" placeholder="Usuario" required></div>
            <div class="input-group"><input type="password" id="password" placeholder="Contraseña" required></div>
            <button type="submit" class="login-btn">Acceder</button>
            <p style="margin-top: 15px; color: #555;">Demo: admin / 123</p>
        </form>
    </div>
</section>

<div id="main-layout">

    <nav id="sidebar">
        <div id="logo-container">
            <img src="img.jpg" alt="Logo SGI" id="logo-img">
            <h2>SGI | Inventario</h2>
        </div>
        <div id="inventory-selector-container">
            <label for="inventory-selector">Inventario Activo:</label>
            <select id="inventory-selector" onchange="changeActiveInventory(this.value)">
            </select>
        </div>

        <a class="sidebar-item active" href="#" onclick="mostrarSeccion('home', this)">
            <span class="material-symbols-outlined">home</span>
            Inicio
        </a>
        <a class="sidebar-item" href="#" onclick="mostrarSeccion('inventario', this)">
            <span class="material-symbols-outlined">inventory</span>
            Ver Inventario
        </a>

        <a class="sidebar-item" href="#" onclick="mostrarSeccion('valoracion', this)">
            <span class="material-symbols-outlined">calculate</span>
            Valoración Total
        </a>

        <a class="sidebar-item" href="#" onclick="mostrarSeccion('nuevo-inventario', this)">
            <span class="material-symbols-outlined">add_to_photos</span>
            Crear Nuevo Inventario
        </a>

        <a class="sidebar-item" href="#" onclick="mostrarSeccion('agregar', this)">
            <span class="material-symbols-outlined">add_box</span>
            Añadir Producto
        </a>

        <a class="sidebar-item" href="#" onclick="abrirModalEliminarInventario()" style="color: var(--color-red);">
            <span class="material-symbols-outlined" style="color: var(--color-red);">delete_forever</span>
            Eliminar un Inventario
        </a>
        <a class="sidebar-item" href="#" onclick="mostrarSeccion('acerca', this)">
            <span class="material-symbols-outlined">info</span>
            Acerca de
        </a>

    </nav>

    <div id="content-area">
        <header>
            <h2 id="current-title" style="margin: 0; color: #555;">Página Principal</h2>
            <button onclick="logout()" class="btn-delete">Cerrar Sesión</button>
        </header>

        <div id="content-wrapper">

            <div id="home-content" class="form-content" style="display:block;">
                <h3 style="color: var(--color-primary);"> Sistema de Gestión Inteligente de Inventario (SGI)</h3>
                <p>El Sistema de Gestión Inteligente de Inventario (SGI) es una plataforma web diseñada para organizaciones,
                    comercios o empresas que manejan un alto volumen de productos o múltiples bodegas, y requieren una herramienta
                    robusta para organizar, controlar y valorizar su inventario de forma efectiva, precisa y en tiempo real.</p>

                <div class="home-card">
                    <h4>Funcionalidades Clave del SGI</h4>
                    <ul>
                        <li>Control CRUD: Crea, edita, busca y elimina productos.</li>
                        <li>Múltiples Inventarios Gestione varios stocks separados (por bodega o tienda).</li>
                        <li>Alerta de Stock: Identifica inmediatamente los productos con existencias bajas (menor a 10 unidades).</li>
                        <li>Valoración Financiera: Calcula el valor total de su inventario en Pesos Colombianos (COP).</li>
                        <li>Interfaz Intuitiva: Diseño moderno, fácil de usar, inspirado en buenas prácticas de usabilidad,
                            para que usuarios con poco conocimiento técnico puedan operar sin dificultades.</li>
                    </ul>
                </div>

                <h3 style="color: var(--color-secondary); margin-top: 30px;">Guía Rápida de Uso (Mini-Tutorial)</h3>

                <div style="display: flex; flex-direction: column; gap: 15px;">

                    <div class="home-card tutorial-card-primary">
                        <h5>1. Ver Inventario</h5>
                        <p>Al seleccionar esta opción, se cargará la tabla completa de productos del inventario activo.
                            Use el buscador para filtrar por ID o nombre. Si hace doble clic en cualquier fila,
                            podrá modificar la cantidad o eliminar el producto.</p>
                    </div>

                    <div class="home-card tutorial-card-secondary">
                        <h5>2. Valoración Total</h5>
                        <p>Su función es calcular automáticamente el valor total de todos los productos
                            disponibles en el inventario activo. Además, muestra el número total de productos únicos,
                            ofreciendo una visión rápida y precisa del patrimonio almacenado.</p>
                    </div>

                    <div class="home-card tutorial-card-yellow">
                        <h5>3. Crear Nuevo Inventario</h5>
                        <p>Permite crear una nueva base de inventario desde cero. El usuario puede asignar un nombre personalizado
                            y definir las categorías principales que servirán para organizar y clasificar todos los productos de manera eficiente.</p>
                    </div>
                </div>

            </div>

            <div id="inventario-content" class="form-content">
                <h3>Inventario Actual (<span id="active-inventory-name">Inventario Principal</span>)</h3>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="search-input" placeholder="Buscar por ID, Nombre, Detalle o Categoría..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <table class="data-table" id="tabla-inventario">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Detalle</th>
                        <th>Cantidad</th>
                        <th>Precio (COP)</th>
                        <th>Categoría</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="valoracion-content" class="form-content">
                <h3 style="color: var(--color-secondary);"> Resumen de Valoración del Inventario</h3>
                <p>Esta sección muestra la cantidad total de artículos únicos en stock y el valor monetario total del inventario.</p>

                <div id="valoracion-results" style="padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f7f7f7; margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <h4>Productos Únicos Disponibles (<span id="active-inventory-name-val">Inventario Principal</span>):</h4>
                        <p id="total-productos" style="font-size: 2em; color: var(--color-primary); font-weight: bold;">Cargando...</p>
                    </div>

                    <div>
                        <h4>Valor Total del Inventario (COP):</h4>
                        <p id="valor-total" style="font-size: 2.5em; color: var(--color-secondary); font-weight: 700;">Cargando...</p>
                    </div>
                </div>
            </div>

            <div id="nuevo-inventario-content" class="form-content">
                <h3>Crear Nuevo Inventario</h3>
                <form id="form-nuevo-inventario">
                    <p>Defina la configuración de su nuevo inventario.</p>
                    <div class="form-group"><label>Nombre:</label><input id="new-inventory-name" placeholder="Ej: Inventario Bodega Principal" required></div>
                    <div class="form-group"><label>Categorías:</label><textarea id="new-inventory-categories" placeholder="Separe las categorías por coma (Ej: Tecnología, Ropa, Hogar)" required></textarea></div>
                    <button class="btn-submit" type="submit" style="margin-top: 20px;">Crear y Activar Inventario</button>
                </form>
            </div>


            <div id="agregar-content" class="form-content">
                <h3>Agregar Producto al Inventario (<span id="add-inventory-name">Inventario Principal</span>)</h3>
                <form id="form-agregar">
                    <div class="form-group"><label>ID:</label><input id="add-id" placeholder="Ej: TEL-001" required></div>
                    <div class="form-group"><label>Nombre:</label><input id="add-nombre" placeholder="Nombre completo del producto" required></div>
                    <div class="form-group"><label>Detalle:</label><input id="add-detalle" placeholder="Ej: Talla M / Rojo, 512GB / Gris" required></div>
                    <div class="form-group"><label>Categoría:</label><input id="add-categoria" placeholder="Ej: Tecnología, Ropa" required></div>
                    <div class="form-group"><label>Cantidad:</label><input type="number" id="add-cantidad" min="1" value="1" required></div>
                    <div class="form-group"><label>Precio:</label><input type="number" id="add-precio" min="0" placeholder="Precio en COP (Ej: 1500000)" required></div>
                    <button class="btn-submit" type="submit" style="margin-top: 20px;">Guardar Producto</button>
                </form>
            </div>

            <div id="acerca-content" class="form-content">
                <h3>Acerca de SGI</h3>
                <p><strong>Desarrolladores:</strong></p>
                <ul>
                    <li>Brayan Piraneque — **Scrum Master**</li>
                    <li>Cristian Quiroga — **Product Owner**</li>
                    <li>Alejandro Jaimes — **Developer Team**</li>
                </ul>
                <p><strong>Versión:</strong> 1.0</p>
                <p><strong>Eslogan:</strong> "Organizamos inventarios, construimos eficiencia"</p>
            </div>

        </div> </div> </div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('edit-modal').style.display='none';" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3 id="modal-product-name" style="color:var(--color-primary);">Detalles del Producto</h3>
        <p>ID: <strong id="modal-product-id"></strong></p>

        <!-- Añadimos campos editables dentro del modal (nombre, detalle, categoría, precio, cantidad) -->
        <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <div class="form-row">
                <label>Nombre:</label>
                <input id="modal-name-input" type="text" />
            </div>

            <div class="form-row">
                <label>Detalle:</label>
                <input id="modal-detail-input" type="text" />
            </div>

            <div class="form-row">
                <label>Categoría:</label>
                <input id="modal-category-input" type="text" />
            </div>

            <div class="form-row">
                <label>Precio:</label>
                <input id="modal-price-input" type="number" min="0" />
            </div>

            <div class="form-row">
                <label>Cantidad:</label>
                <input id="modal-quantity-input" type="number" min="0" />
            </div>

            <button id="btn-save-product" class="btn-submit" style="margin-top: 15px; background-color: var(--color-secondary);">Guardar Cambios</button>
        </div>

        <button id="btn-delete-product" class="btn-delete" style="margin-top: 15px; width:100%;">Eliminar Producto</button>
    </div>
</div>

<div id="delete-inventory-modal" class="modal">
    <div class="modal-content" style="border: 2px solid var(--color-red);">
        <span class="close-btn" onclick="document.getElementById('delete-inventory-modal').style.display='none';" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3 style="color: var(--color-red);">Eliminar un Inventario</h3>
        <p>Seleccione el inventario que desea eliminar permanentemente. <br><strong>¡Esta acción no se puede deshacer!</strong></p>

        <div class="form-group" style="flex-direction: column; align-items: flex-start;">
            <label style="width: 100%; margin-bottom: 5px;">Seleccionar Inventario:</label>
            <select id="delete-inventory-select" style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;">
            </select>
        </div>

        <button onclick="confirmDeleteInventory()" class="btn-delete" style="width: 100%; margin-top: 20px;">Confirmar Eliminación</button>
        <button onclick="document.getElementById('delete-inventory-modal').style.display='none';" class="btn-submit" style="width: 100%; margin-top: 10px; background-color: #777;">Cancelar</button>
    </div>
</div>


<script>
    const VALID_USER = 'admin';
    const VALID_PASS = '123';
    const STOCK_WARNING_LEVEL = 10;
    const INVENTORY_STORAGE_KEY = 'sgi_multiple_inventarios';
    const ACTIVE_INVENTORY_KEY = 'sgi_inventario_activo';
    const PRODUCT_COUNT_TARGET = 100;

    let globalInventories = {};
    let activeInventoryId = 'Inventario Principal';

    function generateInitialData(count) {
        const categories = ['Tecnología', 'Ropa', 'Hogar'];
        const prefixes = { 'Tecnología': 'TEC', 'Ropa': 'ROP', 'Hogar': 'HOG' };
        const sizes = ['S', 'M', 'L', 'XL'];
        const colors = ['Rojo', 'Azul', 'Blanco', 'Negro', 'Gris', 'Verde'];

        const techModels = [
            { name: 'Laptop HP Pavilion', details: ['i5 / 8GB RAM / 512GB SSD', 'i7 / 16GB RAM / 1TB SSD'], priceBase: 2500000 },
            { name: 'Monitor Samsung Curvo', details: ['27 Pulgadas / 144hz', '32 Pulgadas / 60hz'], priceBase: 1200000 },
            { name: 'Consola PS5', details: ['Digital Edition', 'Disco Edition'], priceBase: 3500000 },
            { name: 'Smartphone Xiaomi 13T', details: ['128GB', '256GB'], priceBase: 1800000 }
        ];

        const apparelModels = [
            { name: 'Jean Diesel Slim', priceBase: 150000 },
            { name: 'Camiseta Polo Lacoste', priceBase: 90000 },
            { name: 'Chaqueta Impermeable NorthFace', priceBase: 250000 }
        ];

        const homeModels = [
            { name: 'Licuadora Oster Xpert', priceBase: 180000 },
            { name: 'Juego de Sábanas 400 Hilos', priceBase: 80000 },
            { name: 'Aspiradora Robot Samsung', priceBase: 900000 }
        ];

        let initialData = [];
        const randomPrice = (base) => Math.floor(base * (1 + (Math.random() * 0.5 - 0.25)) / 100) * 100;

        for (let i = 1; i <= count; i++) {
            const categoryIndex = i % categories.length;
            const category = categories[categoryIndex];
            const prefix = prefixes[category];
            const id = `${prefix}-${String(i).padStart(3, '0')}`;
            let nombre, detalle, precio;

            if (category === 'Ropa') {
                const model = apparelModels[Math.floor(Math.random() * apparelModels.length)];
                const size = sizes[Math.floor(Math.random() * sizes.length)];
                const color = colors[Math.floor(Math.random() * colors.length)];
                nombre = model.name;
                detalle = `Talla ${size} / Color ${color}`;
                precio = randomPrice(model.priceBase);
            } else if (category === 'Tecnología') {
                const model = techModels[Math.floor(Math.random() * techModels.length)];
                const detail = model.details[Math.floor(Math.random() * model.details.length)];
                nombre = model.name;
                detalle = detail;
                precio = randomPrice(model.priceBase);
            } else { // Hogar
                const model = homeModels[Math.floor(Math.random() * homeModels.length)];
                nombre = model.name;
                detalle = colors[Math.floor(Math.random() * colors.length)];
                precio = randomPrice(model.priceBase);
            }

            initialData.push({
                id: id,
                nombre: nombre,
                cantidad: Math.floor(Math.random() * 50) + 1,
                precio: precio,
                categoria: category,
                detalle: detalle
            });
        }
        return initialData;
    }

    function loadInventories() {
        const storedInventories = localStorage.getItem(INVENTORY_STORAGE_KEY);
        const storedActiveId = localStorage.getItem(ACTIVE_INVENTORY_KEY);

        if (storedInventories) {
            globalInventories = JSON.parse(storedInventories);
        } else {
            const initialProducts = generateInitialData(PRODUCT_COUNT_TARGET);
            globalInventories['Inventario Principal'] = {
                name: 'Inventario Principal',
                categories: ['Tecnología', 'Ropa', 'Hogar'],
                products: initialProducts
            };
        }

        if (storedActiveId && globalInventories[storedActiveId]) {
            activeInventoryId = storedActiveId;
        } else {
            const keys = Object.keys(globalInventories);
            if (keys.length > 0) activeInventoryId = keys[0];
        }
        saveInventories();
    }

    function saveInventories() {
        localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(globalInventories));
        localStorage.setItem(ACTIVE_INVENTORY_KEY, activeInventoryId);
        updateInventorySelector();
        updateInventoryTitles();
    }

    function getCurrentInventory() {
        return globalInventories[activeInventoryId] ? globalInventories[activeInventoryId].products : [];
    }

    function updateInventoryTitles() {
        if(globalInventories[activeInventoryId]){
            const name = globalInventories[activeInventoryId].name;
            document.getElementById('active-inventory-name').textContent = name;
            document.getElementById('active-inventory-name-val').textContent = name;
            document.getElementById('add-inventory-name').textContent = name;
        }
    }

    function updateInventorySelector() {
        const selector = document.getElementById('inventory-selector');
        selector.innerHTML = '';
        const keys = Object.keys(globalInventories);

        keys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = globalInventories[key].name;
            if (key === activeInventoryId) {
                option.selected = true;
            }
            selector.appendChild(option);
        });
    }

    function changeActiveInventory(newId) {
        if (globalInventories[newId]) {
            activeInventoryId = newId;
            saveInventories();
            renderizarTabla();
            mostrarSeccion('inventario', document.querySelector('.sidebar-item[onclick*="inventario"]'));
            // alert(`Inventario cambiado a: ${globalInventories[newId].name}`);
        }
    }

    const bienvenidaSection = document.getElementById('bienvenida');
    const loginSection = document.getElementById('login-section');
    const mainLayout = document.getElementById('main-layout');
    const tablaBody = document.querySelector('#tabla-inventario tbody');
    const loginForm = document.getElementById('login-form');
    const formAgregar = document.getElementById('form-agregar');
    const formNuevoInventario = document.getElementById('form-nuevo-inventario');
    const searchInput = document.getElementById('search-input');
    const currentTitle = document.getElementById('current-title');

    const totalProductosDisplay = document.getElementById('total-productos');
    const valorTotalDisplay = document.getElementById('valor-total');

    const editModal = document.getElementById('edit-modal');
    const modalProductName = document.getElementById('modal-product-name');
    const modalProductId = document.getElementById('modal-product-id');
    const modalProductDetail = document.getElementById('modal-product-detail'); // not used visually now but left for compatibility
    const modalNameInput = document.getElementById('modal-name-input');
    const modalDetailInput = document.getElementById('modal-detail-input');
    const modalCategoryInput = document.getElementById('modal-category-input');
    const modalPriceInput = document.getElementById('modal-price-input');
    const modalQuantityInput = document.getElementById('modal-quantity-input');
    const btnSaveProduct = document.getElementById('btn-save-product');
    const btnDeleteProduct = document.getElementById('btn-delete-product');

    // Modal de Eliminacion de Inventario
    const deleteInventoryModal = document.getElementById('delete-inventory-modal');
    const deleteInventorySelect = document.getElementById('delete-inventory-select');


    let currentEditProductId = null;

    const formContents = {
        'home': document.getElementById('home-content'),
        'inventario': document.getElementById('inventario-content'),
        'valoracion': document.getElementById('valoracion-content'),
        'nuevo-inventario': document.getElementById('nuevo-inventario-content'),
        'agregar': document.getElementById('agregar-content'),
        'acerca': document.getElementById('acerca-content')
    };

    const titles = {
        'home': 'Página Principal',
        'inventario': 'Gestión de Inventario',
        'valoracion': 'Valoración Económica',
        'nuevo-inventario': 'Configuración de Nuevo Inventario',
        'agregar': 'Añadir Nuevo Artículo',
        'acerca': 'Información del Proyecto'
    };


    document.addEventListener('DOMContentLoaded', () => {
        loadInventories();
        renderizarTabla();

        setTimeout(() => bienvenidaSection.classList.add('hidden-section'), 2000);
        setTimeout(() => {
            bienvenidaSection.style.display = 'none';
            loginSection.style.opacity = '1';
            loginSection.style.visibility = 'visible';
        }, 2500);

        // Listeners del modal
        if (btnSaveProduct) btnSaveProduct.addEventListener('click', saveProductFromModal);
        if (btnDeleteProduct) btnDeleteProduct.addEventListener('click', deleteProductFromModal);

        modalQuantityInput.addEventListener('input', () => {
            modalQuantityInput.value = Math.max(0, parseInt(modalQuantityInput.value) || 0);
        });

        if (searchInput) {
            searchInput.addEventListener('input', filterInventory);
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;

        if (u === VALID_USER && p === VALID_PASS) {
            // Login exitoso
            loginSection.style.opacity = '0';
            setTimeout(() => {
                loginSection.style.display = 'none';
                mainLayout.style.display = 'flex';
                // Asegurar que el inventario activo se muestre correctamente al entrar
                mostrarSeccion('home', document.querySelector('.sidebar-item[onclick*="home"]'));
                renderizarTabla();
            }, 500);
        } else {
            alert('Credenciales incorrectas. Intente de nuevo.');
        }
    });

    function logout() {
        // Opcional: limpiar datos de sesión si existieran
        // sessionStorage.removeItem('isLoggedIn');
        alert('Sesión cerrada. Volviendo a la pantalla de login.');
        mainLayout.style.display = 'none';
        loginSection.style.display = 'flex';
        setTimeout(() => loginSection.style.opacity = '1', 10);
        // Resetear el formulario de login
        loginForm.reset();
        document.getElementById('username').focus();
    }

    // Función para formatear a COP (Pesos Colombianos)
    function formatCOP(number) {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(number);
    }

    // --- Funciones de la Interfaz ---

    function mostrarSeccion(id, element) {
        // Ocultar todas las secciones de contenido
        Object.values(formContents).forEach(content => {
            content.style.display = 'none';
        });

        // Mostrar la sección solicitada
        const targetSection = formContents[id];
        if (targetSection) {
            targetSection.style.display = 'block';
            currentTitle.textContent = titles[id] || 'SGI';

            // Actualizar clase activa del sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }

            // Acciones específicas al cambiar de sección
            if (id === 'inventario') {
                renderizarTabla();
            } else if (id === 'valoracion') {
                calcularValoracion();
            }
        }
    }

    // --- Funciones de Gestión de Inventario (CRUD) ---

    function renderizarTabla(filterText = '') {
        const inventario = getCurrentInventory();
        tablaBody.innerHTML = '';
        const filterLower = filterText.toLowerCase().trim();
        let productosFiltrados = inventario;

        if (filterLower) {
            productosFiltrados = inventario.filter(p =>
                p.id.toLowerCase().includes(filterLower) ||
                p.nombre.toLowerCase().includes(filterLower) ||
                p.detalle.toLowerCase().includes(filterLower) ||
                p.categoria.toLowerCase().includes(filterLower)
            );
        }

        productosFiltrados.forEach(producto => {
            const row = tablaBody.insertRow();
            // Resaltar stock bajo
            if (producto.cantidad <= STOCK_WARNING_LEVEL) {
                row.classList.add('stock-bajo');
            }

            row.insertCell(0).textContent = producto.id;
            row.insertCell(1).textContent = producto.nombre;
            row.insertCell(2).textContent = producto.detalle;
            row.insertCell(3).textContent = producto.cantidad;
            row.insertCell(4).textContent = formatCOP(producto.precio);
            row.insertCell(5).textContent = producto.categoria;

            // Añadir evento de doble clic para editar/eliminar
            row.addEventListener('dblclick', () => openEditModal(producto.id));
        });
    }

    function filterInventory() {
        const filterText = searchInput.value;
        renderizarTabla(filterText);
    }

    function openEditModal(productId) {
        const producto = getCurrentInventory().find(p => p.id === productId);
        if (!producto) {
            alert('Producto no encontrado.');
            return;
        }

        currentEditProductId = productId;
        modalProductName.textContent = producto.nombre || '';
        modalProductId.textContent = producto.id || '';

        // llenar inputs del modal
        modalNameInput.value = producto.nombre || '';
        modalDetailInput.value = producto.detalle || '';
        modalCategoryInput.value = producto.categoria || '';
        modalPriceInput.value = producto.precio !== undefined ? producto.precio : '';
        modalQuantityInput.value = producto.cantidad !== undefined ? producto.cantidad : 0;

        editModal.style.display = 'block';
    }

    // Guardar edición completa desde el modal
    function saveProductFromModal() {
        const newNombre = modalNameInput.value.trim();
        const newDetalle = modalDetailInput.value.trim();
        const newCategoria = modalCategoryInput.value.trim();
        const newPrecio = parseFloat(modalPriceInput.value);
        const newCantidad = parseInt(modalQuantityInput.value);

        // validaciones básicas
        if (!newNombre) {
            alert('El nombre no puede quedar vacío.');
            return;
        }
        if (isNaN(newPrecio) || newPrecio < 0) {
            alert('Precio inválido.');
            return;
        }
        if (isNaN(newCantidad) || newCantidad < 0) {
            alert('Cantidad inválida.');
            return;
        }

        const inventario = globalInventories[activeInventoryId].products;
        const index = inventario.findIndex(p => p.id === currentEditProductId);

        if (index > -1) {
            inventario[index].nombre = newNombre;
            inventario[index].detalle = newDetalle;
            inventario[index].categoria = newCategoria;
            inventario[index].precio = newPrecio;
            inventario[index].cantidad = newCantidad;

            saveInventories();
            renderizarTabla(searchInput.value);
            editModal.style.display = 'none';
            alert(`Producto ${inventario[index].id} actualizado correctamente.`);
        } else {
            alert('Error: producto no encontrado al intentar guardar.');
        }
    }

    function deleteProductFromModal() {
        if (!confirm(`¿Está seguro de que desea ELIMINAR el producto ${currentEditProductId} del inventario?`)) {
            return;
        }

        const inventario = globalInventories[activeInventoryId].products;
        const initialLength = inventario.length;

        // Filtrar para crear un nuevo array sin el producto a eliminar
        globalInventories[activeInventoryId].products = inventario.filter(p => p.id !== currentEditProductId);

        if (globalInventories[activeInventoryId].products.length < initialLength) {
            saveInventories();
            renderizarTabla(searchInput.value);
            editModal.style.display = 'none';
            alert(`Producto ${currentEditProductId} eliminado correctamente.`);
        } else {
            alert('Error al intentar eliminar el producto.');
        }
    }

    function calcularValoracion() {
        const inventario = getCurrentInventory();
        let totalUnicos = inventario.length;
        let valorTotal = 0;

        inventario.forEach(producto => {
            valorTotal += (producto.cantidad * producto.precio);
        });

        totalProductosDisplay.textContent = totalUnicos;
        valorTotalDisplay.textContent = formatCOP(valorTotal);
    }

    // --- Gestión de Formularios ---

    formAgregar.addEventListener('submit', (e) => {
        e.preventDefault();

        const id = document.getElementById('add-id').value.trim();
        const nombre = document.getElementById('add-nombre').value.trim();
        const detalle = document.getElementById('add-detalle').value.trim();
        const categoria = document.getElementById('add-categoria').value.trim();
        const cantidad = parseInt(document.getElementById('add-cantidad').value);
        const precio = parseFloat(document.getElementById('add-precio').value);

        if (getCurrentInventory().some(p => p.id === id)) {
            alert(`Error: Ya existe un producto con el ID "${id}" en este inventario.`);
            return;
        }

        if (isNaN(cantidad) || cantidad <= 0) {
            alert('La cantidad debe ser un número positivo.');
            return;
        }

        if (isNaN(precio) || precio < 0) {
            alert('El precio debe ser un número positivo o cero.');
            return;
        }

        const nuevoProducto = {
            id: id,
            nombre: nombre,
            detalle: detalle,
            categoria: categoria,
            cantidad: cantidad,
            precio: precio
        };

        globalInventories[activeInventoryId].products.push(nuevoProducto);
        saveInventories();
        formAgregar.reset();
        alert(`Producto "${nombre}" agregado al inventario.`);
        mostrarSeccion('inventario', document.querySelector('.sidebar-item[onclick*="inventario"]')); // Muestra la tabla

    });

    formNuevoInventario.addEventListener('submit', (e) => {
        e.preventDefault();

        const newName = document.getElementById('new-inventory-name').value.trim();
        const categoryString = document.getElementById('new-inventory-categories').value.trim();
        const categories = categoryString.split(',').map(c => c.trim()).filter(c => c.length > 0);

        if (globalInventories[newName]) {
            alert(`Error: El nombre de inventario "${newName}" ya existe.`);
            return;
        }

        if (categories.length === 0) {
             alert('Debe definir al menos una categoría.');
            return;
        }

        globalInventories[newName] = {
            name: newName,
            categories: categories,
            products: []
        };

        activeInventoryId = newName;
        saveInventories();
        formNuevoInventario.reset();
        alert(`Inventario "${newName}" creado y activado exitosamente.`);
        mostrarSeccion('home', document.querySelector('.sidebar-item[onclick*="home"]'));
    });

    function abrirModalEliminarInventario() {
        // Limpiar y llenar el selector con todos los inventarios, excluyendo el activo (si es el único)
        deleteInventorySelect.innerHTML = '';
        const keys = Object.keys(globalInventories);

        if (keys.length === 0) {
            alert("No hay inventarios para eliminar.");
            return;
        }

        // Si solo queda un inventario, no se permite eliminarlo
        if (keys.length === 1) {
            alert(`No puede eliminar el único inventario restante: ${globalInventories[keys[0]].name}`);
            return;
        }

        keys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = globalInventories[key].name;
            deleteInventorySelect.appendChild(option);
        });

        deleteInventoryModal.style.display = 'block';
    }

    function confirmDeleteInventory() {
        const inventoryToDeleteId = deleteInventorySelect.value;
        if (!inventoryToDeleteId) {
            alert("Seleccione un inventario.");
            return;
        }

        if (inventoryToDeleteId === activeInventoryId) {
            alert("No puede eliminar el inventario que está actualmente activo. Por favor, cambie el inventario activo antes de eliminar.");
            return;
        }

        if (confirm(`¿Está ABSOLUTAMENTE seguro de que desea eliminar PERMANENTEMENTE el inventario "${globalInventories[inventoryToDeleteId].name}"?`)) {
            delete globalInventories[inventoryToDeleteId];
            saveInventories(); // Esto actualizará el selector
            deleteInventoryModal.style.display = 'none';
            alert(`Inventario "${inventoryToDeleteId}" eliminado con éxito.`);

            // Reabrir el modal con la lista actualizada si es necesario, o volver a Home
            mostrarSeccion('home', document.querySelector('.sidebar-item[onclick*="home"]'));
        }
    }


</script>
</body>
</html>
